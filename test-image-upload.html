<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>测试图片上传</title>
</head>
<body>
    <h1>测试图片上传功能</h1>
    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">
    <br><br>
    <button onclick="testWithoutImage()">测试不带图片</button>
    <br><br>
    <div id="output"></div>

    <script>
        let uploadedImage = null;

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('选择的文件:', file.name, file.type);
            uploadedImage = await fileToBase64(file);
            console.log('图片已转换为Base64，长度:', uploadedImage.length);
            document.getElementById('output').innerHTML = `<p>图片已加载: ${file.name}</p><img src="${uploadedImage}" style="max-width:300px;">`;
        }

        async function testWithoutImage() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>正在测试不带图片的请求...</p>';

            const requestData = {
                "last_prompt": "你好，请介绍一下你自己",
                "conversation_history": []
            };

            console.log('发送请求:', requestData);

            try {
                const response = await fetch('http://127.0.0.1/myapi/v1/chat-bot/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('响应状态:', response.status);
                output.innerHTML += `<p>响应状态: ${response.status}</p>`;

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('错误响应:', errorText);
                    output.innerHTML += `<p style="color:red;">错误: ${errorText}</p>`;
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.success && data.content) {
                                    fullResponse += data.content;
                                    output.innerHTML = `<p>响应内容:</p><pre>${fullResponse}</pre>`;
                                }
                            } catch (e) {
                                console.error('解析错误:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('请求失败:', error);
                output.innerHTML += `<p style="color:red;">请求失败: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
